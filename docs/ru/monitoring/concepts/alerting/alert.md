---
title: Алерт в {{ monitoring-full-name }}
description: Алерт в {{ monitoring-short-name }} — периодически вычисляемый набор последовательных именованных запросов. Более подробно об алертах, их статусах, настройке и использовании вы узнаете из данной статьи.
---

# Алерт

_Алерт_ — периодически вычисляемый набор последовательных именованных [запросов](../data-model.md#queries).

Набор запросов вычисляется раз в минуту. Полученное значение запроса, указанного в [настройках](#alert-parameters), сравнивается с заранее заданными пороговыми значениями.

Если результат запроса, указанного в [настройках](#alert-parameters), достигает порогового значения, {{ monitoring-short-name }} переводит алерт в [статус](#alert-statuses) `{{ ui-key.yacloud_monitoring.alert.status_alarm }}` или `{{ ui-key.yacloud_monitoring.alert.status_warn }}` и оповещает пользователя по [каналу уведомления](./notification-channel.md).

## Статусы алертов {#alert-statuses}

Алерт может находиться в одном из следующих статусов:

Статус | Описание
----- | -----
`{{ ui-key.yacloud_monitoring.alert.status_ok }}` | Значение метрики в пределах установленной нормы.
`{{ ui-key.yacloud_monitoring.alert.status_warn }}` | Значение метрики достигло порога предупреждения `Warning`.
`{{ ui-key.yacloud_monitoring.alert.status_alarm }}` | Значение метрики достигло порога критического статуса `Alarm`.
`{{ ui-key.yacloud_monitoring.alert.status_no_data }}` | Для вычисления функции алерта не хватает данных метрик.
`{{ ui-key.yacloud_monitoring.alert.status_error }}` | Значение алерта вычислить невозможно.

## История вычислений алерта {#evaluation-history}

История вычислений алерта представлена в виде графика, состоящего из столбцов, цвет которых зависит от статуса алерта на момент его вычисления.

Для навигации по истории можно выбрать один из предустановленных масштабов отображения:

* `1h` — 1 час.
* `1d` — 1 день.
* `1w` — 1 неделя.
* `1m` — 1 месяц.

Минимальный масштаб отображения истории — `1h`: каждый столбец на графике показывает статус алерта в соответствующую минуту. При больших масштабах цвет столбца составляется из статусов, вычисленных в этом интервале.

При нажатии на столбец загружается информация о настройках алерта в выбранный момент вычисления.

{% note info %}

При загрузке информации из истории вычисления производится повторный расчет статуса алерта, который отображается в поле **{{ ui-key.yacloud_monitoring.monitoring-alerts.list-table.evaluation-stats-single }}**. Статус алерта в истории может не совпадать с текущим результатом вычисления из-за особенностей [прореживания исторических данных](../decimation.md) или задержек при [поставке данных](../data-collection/unified-agent/index.md) в {{ monitoring-name }}.

{% endnote %}

## Настройки алерта {#alert-parameters}

Настройки алерта задаются при его создании. После сохранения алерта их можно изменить.

### Запросы {#queries}

Набор [запросов](../data-model.md#queries), которые возвращают линию или набор линий.

Можно:

* отключить вычисление запроса, нажав кнопку ![image](../../../_assets/console-icons/ellipsis.svg) и выбрав **{{ ui-key.yacloud_monitoring.actions.common.deactivate }}**. Ссылки на запросы, которые не вычисляются, приводят к ошибкам.
* скрыть результаты вычисления запроса на графике, нажав кнопку ![image](../../../_assets/console-icons/eye.svg).
* отобразить результаты вычисления запроса на графике, нажав кнопку ![image](../../../_assets/console-icons/eye-slash.svg).

### Условия срабатывания {#condition}

#### Запрос для проверки {#request}

Имя запроса, к результату вычисления которого применяется [функция агрегации](#aggregation).

#### Функция агрегации {#aggregation}

Функция агрегации применяется к результату вычисления [запроса для проверки](#request).

Функция агрегации| Описание
----- | -----
**{{ ui-key.yacloud_monitoring.monitoring-alerts.threshold-type.at-least-one }}** | Хотя бы одно из значений метрики в запросе превышает заданные пороги в указанном периоде.
**{{ ui-key.yacloud_monitoring.monitoring-alerts.threshold-type.at-all-times }}** | Все значения метрики в запросе превышают заданные пороги в указанном периоде.
**{{ ui-key.yacloud_monitoring.monitoring-alerts.threshold-type.avg }}** | Вычисляет среднее значение в указанном периоде для каждой метрики. Например, если запрос возвращает две метрики, {{ monitoring-short-name }} для каждой из них вычисляет среднее значение в указанном окне.
**{{ ui-key.yacloud_monitoring.monitoring-alerts.threshold-type.count }}** | Вычисляет количество значений метрики в указанном периоде.
**{{ ui-key.yacloud_monitoring.monitoring-alerts.threshold-type.last-non-nan }}** | Использует последнее значение метрики в указанном периоде. Если значения метрики не удалось получить, {{ monitoring-full-name }} меняет статус алерта на `{{ ui-key.yacloud_monitoring.alert.status_no_data }}`.
**{{ ui-key.yacloud_monitoring.monitoring-alerts.threshold-type.max }}** | Использует максимальное значение метрики в указанном периоде.
**{{ ui-key.yacloud_monitoring.monitoring-alerts.threshold-type.min }}** | Использует минимальное значение метрики в указанном периоде.
**{{ ui-key.yacloud_monitoring.monitoring-alerts.threshold-type.sum }}** | Вычисляет сумму значений за указанный период для каждой метрики.

Например, чтобы следить за последним значением метрики, которое было в течение последних 15 минут, необходимо выбрать функцию **{{ ui-key.yacloud_monitoring.alert.title_aggregation-last_non_nan }}** и задать [окно вычисления](#evaluation-window) `15m`.

#### Функция сравнения {#comparison}

Функция сравнения применяется к результату вычисления [функции агрегации](#aggregation) и пороговым значениям [{{ ui-key.yacloud_monitoring.alert.status_warn }}](#warn) и [{{ ui-key.yacloud_monitoring.alert.status_alarm }}](#alarm). Если агрегированное значение удовлетворяет пороговому, {{ monitoring-name }} изменяет статус алерта.

#### {{ ui-key.yacloud_monitoring.alert.status_warn }} {#warning}

Пороговое значение, при достижении которого алерт перейдет в статус `{{ ui-key.yacloud_monitoring.alert.status_warn }}`.

#### {{ ui-key.yacloud_monitoring.alert.status_alarm }} {#alarm}

Пороговое значение, при достижении которого алерт перейдет в статус `{{ ui-key.yacloud_monitoring.alert.status_alarm }}`.

#### Окно вычисления {#evaluation-window}

Временной период, в котором рассчитывается [функция агрегации](#aggregation). Окно позволяет исключить резкие изменения значения метрик, реагируя только на изменения за больший промежуток времени.

Можно выбрать одно из предустановленных значений или задать свое в следующем формате:
* `1h` — 1 час.
* `1m` — 1 минута.
* `1s` — 1 секунда.

Например, значение `3m 45s` задает временное окно в 3 минуты 45 секунд.

#### Задержка вычисления {#evaluation-delay}

Cдвиг временного окна назад во времени в секундах. По умолчанию равен 0. Позволяет исключить неожиданное срабатывание алерта в тех случаях, когда в запросах используются метрики, которые собираются с разным интервалом. Можно выбрать одно из предустановленных значений или задать свое аналогично [окну вычисления](#evaluation-window).

## Обработка отсутствия данных {#no-data-policy}

Политики обработки устанавливают статус алерта, когда во временном окне нет данных или отсутствуют метрики по заданному критерию. Политики применяются перед проверкой условий срабатывания.

Вы можете обработать отсутствие метрик или точек во временном окне двумя способами:

* Сменить статус алерта с помощью политик [Отсутствие метрик по селектору](#no-metrics-policy) или [Отсутствие точек в окне вычисления](#no-points-policy).
* Обработать [вручную](#manual-policy).

{% note info %}

Чтобы алерты переходили в статус `No data` при отсутствии метрик или точек во временном окне, выставите для всех типов алертов значение политик `No data`. Использование `Default` и `Manual` не рекомендуется, так как это требует дополнительной [ручной обработки](#manual-policy).

{% endnote %}

### Отсутствие метрик по селектору {#no-metrics-policy}

Политика определяет статус алерта, если хотя бы по одному селектору не было найдено метрик. Например, метрик не существует или они были удалены как устаревшие — [TTL](../ttl.md).

Возможные значения:

* `По умолчанию` — значение по умолчанию `No data` для всех типов алертов.
* `OK` — переводит алерт в статус `OK`.
* `Warn` — переводит алерт в статус `Warning`.
* `Alarm` — переводит алерт в статус `Alarm`.
* `No data` — переводит алерт в статус `No data`.
* `Manual` — поддерживается только для алертов с типом `Выражение` и передает управление программе алерта для [обработки вручную](#manual-policy).
  
    Если для такого алерта хотя бы по одному селектору не нашлось метрик и не сработала ни одна функция управления статусом, алерт перейдет в состояние `OK`.

### Отсутствие точек в окне вычисления {#no-points-policy}

Политика определяет статус алерта, если хотя бы для одной из метрик во временном окне нет точек.

Для пороговых алертов, настроенных на несколько метрик, предикаты выполняются независимо для каждой метрики. Итоговый статус алерта — агрегация статусов для каждой из метрик в следующем порядке: `No data` < `OK` < `Warning` < `Error` < `Alarm`. Если политика `Отсутствие точек в окне вычисления` переведет такой пороговый алерт, например, в статус `Warning` из-за отсутствия точек в одной линии, а для другой линии выполнится предикат, переводящий алерт в статус `Alarm`, то итоговый статус алерта будет `Alarm`.

Возможные значения:

* `Default` — значение по умолчанию `No data` для всех типов пороговых алертов и `Manual` для алертов с типом `Выражение`.
* `OK` — переводит алерт в статус `OK`.
* `Warning` — переводит алерт в статус `Warning`.
* `Alarm` — переводит алерт в статус `Alarm`.
* `No data` — переводит алерт в статус `No data`.
* `Manual` — передает управление предикатам или программе алерта для обработки [вручную](#manual-policy).

Если для алерта с типом `Выражение` в параметре `Отсутствие точек в окне вычисления` указано значение `Manual` или `Default`, во временном окне нет точек и в программе алерта не сработала никакая функция управления статусом, то алерт перейдет в состояние `OK`. Рекомендуется использовать значение `No data` для политики `Отсутствие точек в окне вычисления`. Если указано значение `Manual` или `Default`, отсутствие точек обрабатывается [вручную](#manual-policy).

### Ручная обработка отсутствия данных {#manual-policy}

Если для любой политики указано значение `Manual`, управление будет передано предикатам алерта или программе.

Не рекомендуется использовать значение `Manual` — это усложняет программу алерта. В большинстве случаев достаточно воспользоваться значением политики `No data`.

#### Отсутствие метрик {#no-metrics-manual}

Чтобы вручную обработать отсутствие метрик в алерте типа `Выражение`, воспользуйтесь функцией `size` и функциями управления статусом — вы получите количество метрик по заданному селектору.

Пример программы, которая переведет алерт в статус `OK`, если по селектору, указанному в переменной `xx5`, нашлось 0 метрик:

```javascript
let xx5 = {
  project="solomon",
  cluster="production",
  service="gateway",
  endpoint="*",
  code="5*",
  method="*",
  host="cluster",
  name="http.server.requests.status"
};
...
ok_if(size(xx5) == 0);
...
```

#### Отсутствие точек {#no-points-manual}

Чтобы вручную обработать отсутствие точек, воспользуйтесь функцией `count` и функциями управления статусом — вы получите количество точек для заданного селектора во временном окне.

Пример программы, которая переведет алерт в статус `No data`, если для метрики в переменной `source` во временном окне нет точек:

```javascript
let source = {
  project="solomon",
  cluster="production",
  service="alerting",
  endpoint="api.telegram.org/send*",
  host="cluster",
  name="http.client.call.inFlight"
};
...
no_data_if(count(source) == 0);
...
```
