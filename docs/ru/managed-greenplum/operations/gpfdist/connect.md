# Подключение к внешнему файловому серверу

[{{ GP }} Parallel File Server]({{ gp.docs.vmware }}/5/greenplum-database/utility_guide-admin_utilities-gpfdist.html) (`gpfdist`) — утилита для чтения и записи данных из файлов, расположенных на удаленных серверах. Она установлена на всех хостах-сегментах кластера {{ mgp-name }} и обеспечивает параллельную загрузку данных, распределяя их между сегментами равномерно или согласно заданному [ключу дистрибуции](../../concepts/sharding.md#distribution-key). Это повышает производительность при работе с большими объемами внешних данных.

Утилита `gpfdist` может работать с любыми текстовыми файлами, которые содержат разделители, а также со сжатыми файлами gzip и bzip2.

Для чтения или записи файлов на внешнем сервере:
1. [Установите и запустите](#run-gpfdist) `gpfdist` в составе пакета {{ GP }} Loader или {{ GP }} Database на удаленном сервере, где находятся нужные файлы.
1. [Создайте внешнюю таблицу](#create-gpfdist-table), которая будет ссылаться на эти файлы, в базе данных {{ GP }}.

## Запуск gpfdist {#run-gpfdist}


{% note info %}

Скачивание и использование продуктов с сайта VMware не входит в [условия использования {{ mgp-full-name }}]({{ link-cloud-terms-of-use }}) и является предметом отдельного регулирования между клиентом и VMware. Яндекс не несет ответственности за взаимоотношения клиента и VMware, вытекающие из использования клиентом продуктов или услуг VMware.

{% endnote %}


1. Скачайте и установите пакет {{ GP }} Loader с [сайта VMware]({{ gp.docs.vmware }}/5/greenplum-database/client_tool_guides-load-windows-win_load_install.html) или пакет {{ GP }} Database из бакета {{ objstorage-full-name }} по [инструкции](../greenplum-db.md).

1. Запустите утилиту `gpfdist`:

    ```bash
    gpfdist -d <директория_с_файлами_данных> -p <порт_подключения> -l <путь_к_файлу_логов>
    ```

    Где:

    * `<директория_с_файлами_данных>` — локальный путь к директории, в которой хранятся файлы для чтения или записи данных через [внешнюю таблицу](../../concepts/external-tables.md).
    * `<порт_подключения>` — порт, через который будет работать утилита. По умолчанию — `8080`.
    * `<путь_к_файлу_логов>` — (опционально) путь к файлу, в который `gpfdist` будет записывать логи своей работы.

    Чтобы распределить нагрузку на сеть, вы можете запустить несколько экземпляров `gpfdist` на одном сервере, указав разные директории и порты для подключения, например:

    ```bash
    gpfdist -d /var/load_files1 -p 8081 -l /home/gpadmin/log1 & \
    gpfdist -d /var/load_files2 -p 8082 -l /home/gpadmin/log2 &
    ```

1. Проверьте, что файлы в указанной директории доступны на указанном порту из {{ yandex-cloud }}. Для этого выполните команду с ВМ в {{ yandex-cloud }}:

    ```bash
    wget http://hostname:port/filename
    ```

## Создание внешней таблицы с использованием утилиты gpfdist {#create-gpfdist-table}

Синтаксис SQL-запроса для создания внешней таблицы:

```sql
CREATE [WRITABLE] EXTERNAL TABLE <имя_таблицы>
       (<имя_столбца> <тип_данных> [, ...])
       LOCATION('gpfdist://<путь_к_файлу_на_удаленном_сервере>' [, ...])
       FORMAT '[TEXT|CSV|CUSTOM]';
```

Где:

* `<имя_таблицы>` — имя внешней таблицы, которая будет создана в базе данных {{ GP }}.
* `<имя_столбца>` — имя столбца таблицы.
* `<тип_данных>` — тип данных столбца таблицы.
* `<путь_к_файлу_на_удаленном_сервере>` — адрес сервера, на котором запущен `gpfdist`, порт для подключения и путь к файлу. Вы можете указать конкретный файл или задать маску с помощью символа звездочки (\*).

Опция `WRITABLE` позволяет записывать данные во внешний объект. Чтобы считать данные из внешнего объекта, создайте внешнюю таблицу с опцией `READABLE`.

## Примеры создания внешних таблиц {#gpfdist-examples}

* Создание внешней таблицы с данными из файла `file.csv` на сервере `hostname`:

    ```sql
    CREATE EXTERNAL TABLE tableName (id int)
           LOCATION('gpfdist://hostname:8080/file.csv')
           FORMAT 'CSV' (DELIMITER ',');
    ```

* Создание внешней таблицы, объединяющей данные из всех файлов формата `txt`, где `|` — символ разделителя, а пробел — значение `NULL`, на серверах `hostname1` и `hostname2`:

    ```sql
    CREATE EXTERNAL TABLE tableName (...)
           LOCATION('gpfdist://hostname1:8081/*.txt',
                    'gpfdist://hostname2:8081/*.txt')
           FORMAT 'TEXT' (DELIMITER '|' NULL ' ');
    ```

{% include [greenplum-trademark](../../../_includes/mdb/mgp/trademark.md) %}
