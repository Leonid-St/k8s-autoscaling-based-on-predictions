{% list tabs group=instructions %}

- CLI {#cli}

   1. Создайте подсеть:
      
      ```bash
      yc vpc subnet create \
         --name <название_подсети> \
         --zone <зона_доступности> \
         --network-id <идентификатор_сети> \
         --range <CIDR_подсети>
      ```

      Где:

      * `--name` — название подсети.
      * `--zone` — зона доступности: `{{ region-id }}-a`, `{{ region-id }}-b` или `{{ region-id }}-d`.
      * `--network-id` — идентификатор сети, в которую входит новая подсеть.
      * `--range` — список IPv4-адресов, откуда или куда будет поступать трафик. Например, `10.0.0.0/22` или `192.168.0.0/16`. Адреса должны быть уникальными внутри сети. Минимальный размер подсети — `/28`, а максимальный размер подсети — `/16`. Поддерживается только IPv4.

   1. Перенесите группу узлов в новую зону доступности. Ниже приведен пример команды для переноса группы, расположенной в одной зоне:

      ```bash
      {{ yc-k8s }} node-group update \
         --id <идентификатор_группы_узлов> \
         --location zone=<зона_доступности>,subnet-id=<идентификатор_подсети> \
         --network-interface subnets=<идентификатор_подсети>,`
              `ipv4-address=nat,`
              `security-group-ids=[<идентификаторы_групп_безопасности>]
      ```

      Где:

      * `id` — идентификатор группы узлов, которую вы переносите в другую зону доступности.
      * `zone` — зона доступности, в которую вы переносите группу узлов: `{{ region-id }}-a`, `{{ region-id }}-b` или `{{ region-id }}-d`.
      * `subnet-id` и `subnets` — идентификатор новой подсети, созданной ранее.
      * `ipv4-address` — способ назначения IPv4-адреса. Значение `nat` позволяет присвоить узлам публичные и внутренние IP-адреса.
      * `security-group-ids` — список идентификаторов [групп безопасности](../../managed-kubernetes/operations/connect/security-groups.md).

      {% note warning %}

      Если вы хотите сохранить для группы узлов значения других параметров сети, также укажите их в параметре `network-interface`. Иначе группа может быть пересоздана со значениями по умолчанию. Подробнее см. [Изменение группы узлов Managed Service for Kubernetes](../../managed-kubernetes/operations/node-group/node-group-update.md).

      {% endnote %}

      Важно передать параметры `ipv4-address` и `security-group-ids` в команде — это позволит назначить группе узлов публичные IP-адреса и сохранить в ней группы безопасности.

      Команда пересоздает узлы внутри их группы в указанной зоне доступности и подсети. При пересоздании учитываются настройки развертывания — максимальное количество узлов, на которое разрешается увеличить или уменьшить размер группы по сравнению с исходным количеством узлов.

      {% cut "Как перенести группу узлов, расположенную в разных зонах доступности" %}

      В этом случае используйте команду:

      ```bash
      {{ yc-k8s }} node-group update \
         --id <идентификатор_группы_узлов> \
         --location zone=<зона_доступности>,subnet-id=<идентификатор_подсети> \
         ...
         --location zone=<зона_доступности>,subnet-id=<идентификатор_подсети> \
         --network-interface subnets=[<идентификаторы_подсетей>],`
              `ipv4-address=nat,`
              `security-group-ids=[<идентификаторы_групп_безопасности>]
      ```

      Где:

      * `id` — идентификатор группы узлов, которую вы переносите в другую зону доступности.
      * `zone` — зона доступности: `{{ region-id }}-a`, `{{ region-id }}-b` или `{{ region-id }}-d`. Укажите параметры `location` для каждой зоны доступности, в которой будет располагаться группа узлов.
      * `subnet-id` и `subnets` — идентификаторы подсетей для указанных зон доступности.
      * `ipv4-address` — способ назначения IPv4-адреса. Значение `nat` позволяет присвоить узлам публичные и внутренние IP-адреса.
      * `security-group-ids` — список идентификаторов [групп безопасности](../../managed-kubernetes/operations/connect/security-groups.md).

      {% endcut %}

- {{ TF }} {#tf}

   {% note alert %}

   Чтобы убедиться, что группа узлов не будет пересоздана (если вы не делаете это намеренно), изучите вывод команд `terraform plan` и `terraform apply` перед применением конфигурации.

   Перенести группу узлов в другую зону доступности без пересоздания можно только при наличии в конфигурационном файле блока `allocation_policy`.

   {% endnote %}

   1. Внесите следующие изменения в конфигурационный файл:
      * Добавьте манифест новой подсети (ресурс `yandex_vpc_subnet`) в зоне доступности, в которую вы хотите перенести группу узлов.
      * Измените параметры местоположения группы узлов (ресурс `yandex_kubernetes_node_group`):
        * `allocation_policy.location.subnet_id` — удалите этот параметр, если он есть в манифесте.
        * `allocation_policy.location.zone` — укажите зону доступности, в которую вы хотите перенести группу узлов.
        * `instance_template.network_interface.subnet_ids` — укажите идентификатор новой подсети. Добавьте этот параметр, если его нет в манифесте.

      ```hcl
      resource "yandex_vpc_subnet" "my-new-subnet" {
         name           = "<название_подсети>"
         zone           = "<зона_доступности>"
         network_id     = "<идентификатор_сети>"
         v4_cidr_blocks = ["<CIDR_подсети>"]
      }
      ...
      resource "yandex_kubernetes_node_group" "k8s-node-group" {
         allocation_policy {
            location {
               zone = "<зона_доступности>"
            }
         }
         ...
         instance_template {
            network_interface {
               subnet_ids = [yandex_vpc_subnet.my-new-subnet.id]
               ...
            }
            ...
         }
         ...
      }
      ```

      Где:

      * `name` — имя подсети.
      * `zone` — зона доступности, в которую вы переносите группу узлов: `{{ region-id }}-a`, `{{ region-id }}-b` или `{{ region-id }}-d`.
      * `network_id` — идентификатор сети, в которую входит новая подсеть.
      * `v4_cidr_blocks` — список IPv4-адресов, откуда или куда будет поступать трафик. Например, `10.0.0.0/22` или `192.168.0.0/16`. Адреса должны быть уникальными внутри сети. Минимальный размер подсети — `/28`, а максимальный размер подсети — `/16`. Поддерживается только IPv4.
      * `subnet_ids` — идентификатор новой подсети.

   1. Проверьте корректность конфигурационного файла.

      {% include [terraform-validate](../mdb/terraform/validate.md) %}

   1. Подтвердите изменение ресурсов.

      {% include [terraform-apply](../mdb/terraform/apply.md) %}

   Узлы группы будут пересозданы в указанной зоне доступности и подсети. При пересоздании учитываются настройки развертывания — максимальное количество узлов, на которое разрешается увеличить или уменьшить размер группы по сравнению с исходным количеством узлов.

{% endlist %}